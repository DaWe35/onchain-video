<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to Fragmented MP4 Converter and Uploader</title>
    <script src="/convert/ffmpeg.min.js"></script>
    <script src="/convert/ffmpeg-core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" integrity="sha512-f+t6//rz3Iy3hp1CiwtsigYtyWuGk7bf6xl2RTOPvmyMIfTQJ4iy6Lg1dah1bsLQ9SLideJGicgmOkBsBXP1aA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <h1>Video to Fragmented MP4 Converter and Uploader</h1>
    <input type="file" id="videoInput" accept="video/*">
    <div id="progressContainer" style="display: none;">
        <progress id="progressBar" value="0" max="100"></progress>
        <span id="progressText">0%</span>
    </div>
    <div id="status"></div>
    <button id="connectWalletBtn" style="display: none;">Connect Wallet</button>
    <button id="switchNetworkBtn" style="display: none;">Switch to Blast Sepolia</button>
    <button id="createAndUploadBtn" style="display: none;">Create Playlist and Upload Chunks</button>
    <div id="playlistInfo" style="display: none;"></div>
    <div id="walletStatus" style="display: none;">Connecting wallet...</div>

    <script>
        // Constants and global variables
        const { createFFmpeg, fetchFile } = FFmpeg;
        const contractAddress = "0x321d18b119296e298c96b8506b9aa83d6e9eb52f";
        const CHUNK_SIZE = 40 * 1024; // 40 KB
        let provider, signer, contract;
        let convertedVideo, chunkCount, uploadedChunks = 0;
        let contractABI, isABILoaded = false, isFFmpegLoaded = false;

        // FFmpeg initialization
        const ffmpeg = createFFmpeg({ 
            log: true,
            progress: ({ ratio }) => {
                const percent = (ratio * 100).toFixed(2);
                document.getElementById('progressBar').value = percent;
                document.getElementById('progressText').textContent = `${percent}%`;
            }
        });

        // Utility functions
        async function loadFFmpeg() {
            if (!isFFmpegLoaded) {
                await ffmpeg.load();
                isFFmpegLoaded = true;
            }
        }

        async function loadABI() {
            try {
                const response = await fetch('/contract/abi.json');
                contractABI = await response.json();
                isABILoaded = true;
                console.log("ABI loaded successfully");
            } catch (error) {
                console.error("Failed to load ABI:", error);
            }
        }

        function isContractInitialized() {
            return contract !== undefined && contract !== null;
        }

        function updateUploadButton() {
            const btn = document.getElementById('uploadChunksBtn');
            btn.textContent = `Upload Chunks (${uploadedChunks}/${chunkCount})`;
        }

        // Main functions
        async function connectWallet() {
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.style.display = 'block';
            walletStatus.textContent = 'Connecting wallet...';

            if (typeof window.ethereum !== 'undefined') {
                try {
                    if (!isABILoaded) {
                        throw new Error("ABI not loaded. Please refresh the page and try again.");
                    }
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    
                    // Add this check
                    if (!contract.createPlaylist || !contract.addChunk) {
                        throw new Error("Contract methods not found. Please check the ABI and contract address.");
                    }

                    document.getElementById('connectWalletBtn').style.display = 'none';
                    checkNetwork();
                    console.log("Contract initialized:", isContractInitialized());
                    console.log("Available contract methods:", Object.keys(contract));
                    walletStatus.textContent = 'Wallet connected successfully!';
                    setTimeout(() => { walletStatus.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                    walletStatus.textContent = error.message || 'Failed to connect wallet. Please try again.';
                }
            } else {
                walletStatus.textContent = 'Please install MetaMask to use this feature.';
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if (network.name !== 'blast-sepolia') {
                document.getElementById('switchNetworkBtn').style.display = 'inline';
            } else {
                document.getElementById('createAndUploadBtn').style.display = 'inline';
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xa0c71fd' }], // Blast Sepolia chain ID
                });
                document.getElementById('switchNetworkBtn').style.display = 'none';
                document.getElementById('createAndUploadBtn').style.display = 'inline';
            } catch (error) {
                console.error('Failed to switch network:', error);
                document.getElementById('status').textContent = 'Failed to switch network. Please try again.';
            }
        }

        async function createPlaylistAndUploadChunks() {
            const inputFile = document.getElementById('videoInput').files[0];
            try {
                if (!isContractInitialized()) {
                    throw new Error("Contract is not initialized. Please connect your wallet first.");
                }

                const statusElement = document.getElementById('status');
                statusElement.textContent = 'Preparing transactions...';

                const MAX_GAS_PER_TX = 30000000; // Fixed gas limit per transaction

                // Create playlist transaction
                const createPlaylistTx = await contract.createPlaylist.populateTransaction(inputFile.name, 0, "{}");
                console.log("Create playlist transaction:", createPlaylistTx);

                // Prepare chunk upload transactions
                const chunkTxs = [];
                for (let i = 0; i < chunkCount; i++) {
                    const chunk = convertedVideo.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                    const tx = await contract.addChunk.populateTransaction(ethers.hexlify(chunk), 0);
                    chunkTxs.push(tx);
                }

                console.log("First chunk transaction:", chunkTxs[0]);

                // Calculate total number of transactions
                const totalTransactions = 1 + chunkTxs.length; // 1 for createPlaylist + number of chunks

                statusElement.textContent = `Please sign ${totalTransactions} transaction(s)...`;

                // Send transactions
                const allTxs = [createPlaylistTx, ...chunkTxs];
                for (let i = 0; i < allTxs.length; i++) {
                    statusElement.textContent = `Signing transaction ${i + 1} of ${totalTransactions}...`;
                    const tx = allTxs[i];
                    tx.gasLimit = MAX_GAS_PER_TX;
                    const result = await signer.sendTransaction(tx);
                    statusElement.textContent = `Waiting for transaction ${i + 1} to be mined...`;
                    await result.wait();
                }

                statusElement.textContent = 'All chunks uploaded successfully!';
                displayPlaylistInfo();
            } catch (error) {
                console.error('Failed to create playlist and upload chunks:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        }

        async function displayPlaylistInfo() {
            const address = await signer.getAddress();
            const playlistCount = await contract.getPlaylistCount(address);
            const playlist = await contract.getPlaylist(address, playlistCount - 1);
            const playlistInfo = document.getElementById('playlistInfo');
            playlistInfo.innerHTML = `
                <h2>Playlist Information</h2>
                <p>Filename: ${playlist.filename}</p>
                <p>Duration: ${playlist.duration}</p>
                <p>Chunk IDs: ${playlist.chunkIds.join(', ')}</p>
            `;
            playlistInfo.style.display = 'block';
        }

        async function convertToFragmentedMP4(inputFile) {
            const statusElement = document.getElementById('status');
            const progressContainer = document.getElementById('progressContainer');
            statusElement.textContent = 'Converting...';
            progressContainer.style.display = 'block';

            try {
                await loadFFmpeg();
                const inputFileName = 'input_video';
                const outputFileName = 'output_fragmented.mp4';
                ffmpeg.FS('writeFile', inputFileName, await fetchFile(inputFile));
                await ffmpeg.run('-i', inputFileName, '-movflags', 'frag_keyframe+empty_moov+default_base_moof', outputFileName);
                const data = ffmpeg.FS('readFile', outputFileName);
                convertedVideo = new Uint8Array(data.buffer);
                chunkCount = Math.ceil(convertedVideo.length / CHUNK_SIZE);
                document.getElementById('connectWalletBtn').style.display = 'inline';
                statusElement.textContent = 'Conversion complete! Please connect your wallet to continue.';
            } catch (error) {
                console.error('Conversion error:', error);
                statusElement.textContent = 'Conversion failed. Please try again.';
            } finally {
                progressContainer.style.display = 'none';
            }
        }

        // Event listeners
        document.getElementById('videoInput').addEventListener('change', async (event) => {
            const inputFile = event.target.files[0];
            if (inputFile) {
                await convertToFragmentedMP4(inputFile);
            }
        });

        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('switchNetworkBtn').addEventListener('click', switchNetwork);
        document.getElementById('createAndUploadBtn').addEventListener('click', createPlaylistAndUploadChunks);

        // Initialize
        loadABI();
    </script>
</body>
</html>