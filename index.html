<!DOCTYPE html>
<html lang="en">

<body>
    <video id="videoPlayer" controls style="max-width: 400px;"></video>
    <div id="stats">
        <p>Transactions downloaded: <span id="chunksDownloaded">0</span></p>
        <p>MBs downloaded: <span id="mbsDownloaded">0.00</span> MB</p>
    </div>

    <script>
        let mediaSource;
        let sourceBuffer;
        let currentSegment = 0;
        const segmentPrefix = 'segment_';
        const delay = 200; // Delay between segments in milliseconds
        let totalBytesDownloaded = 0;
        let chunksDownloaded = 0;

        async function loadVideo() {
            setupMediaSource();
        }

        function setupMediaSource() {
            const video = document.getElementById('videoPlayer');
            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', sourceOpen);
        }

        function sourceOpen() {
            const mimeCodec = 'video/mp4; codecs="avc1.640028, mp4a.40.2"';
            if (!MediaSource.isTypeSupported(mimeCodec)) {
                console.error('Unsupported MIME type or codec: ', mimeCodec);
                return;
            }

            try {
                sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
                loadNextSegment();
            } catch (e) {
                console.error('Exception while adding source buffer', e);
            }
        }

        async function loadNextSegment() {
            const segmentName = segmentPrefix + String.fromCharCode(97 + Math.floor(currentSegment / 26 / 26 / 26)) +
                String.fromCharCode(97 + Math.floor(currentSegment / 26 / 26) % 26) +
                String.fromCharCode(97 + Math.floor(currentSegment / 26) % 26) +
                String.fromCharCode(97 + (currentSegment % 26));
            const url = `video_segments/${segmentName}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    mediaSource.endOfStream();
                    return;
                }
                const segmentBuffer = await response.arrayBuffer();

                // Check if sourceBuffer is too big
                await waitForSourceBuffer();

                sourceBuffer.appendBuffer(segmentBuffer);
                currentSegment++;

                // Update stats
                chunksDownloaded++;
                totalBytesDownloaded += segmentBuffer.byteLength;
                updateStats();

                // Wait for the segment to be processed before loading the next one
                sourceBuffer.addEventListener('updateend', () => {
                    setTimeout(loadNextSegment, delay);
                }, { once: true });
            } catch (error) {
                console.error('Error loading segment:', error);
                mediaSource.endOfStream();
            }
        }

        function waitForSourceBuffer() {
            return new Promise((resolve) => {
                const checkBuffer = () => {
                    const sizeThreshold = 10 * 1024 * 1024; // 50 MB

                    if (sourceBuffer.buffered.length > 0) {
                        const bufferEnd = sourceBuffer.buffered.end(sourceBuffer.buffered.length - 1);
                        
                        // Estimate buffer size (this is an approximation)
                        const estimatedBufferSize = totalBytesDownloaded - (document.getElementById('videoPlayer').currentTime * (totalBytesDownloaded / bufferEnd));

                        if (estimatedBufferSize < sizeThreshold) {
                            resolve();
                        } else {
                            setTimeout(checkBuffer, 1000); // Check again after 1 second
                        }
                    } else {
                        resolve(); // If there's no buffered data, proceed with appending
                    }
                };
                checkBuffer();
            });
        }

        function updateStats() {
            document.getElementById('chunksDownloaded').textContent = chunksDownloaded;
            const mbsDownloaded = (totalBytesDownloaded / (1024 * 1024)).toFixed(2);
            document.getElementById('mbsDownloaded').textContent = mbsDownloaded;
        }

        // Initialize the video loading
        loadVideo();

        // Error handling for video element
        const video = document.getElementById('videoPlayer');
        video.addEventListener('error', function () {
            console.error('Video error:', video.error);
        });
    </script>
</body>

</html>